{% extends "base.html" %}

{% block title %}Game {{ code }} - Among Us IRL{% endblock %}

{% block content %}
<div class="container">
    <!-- Lobby Screen -->
    <div id="lobby-screen" class="screen">
        <div class="game-code-display">
            <span class="label">Game Code</span>
            <span class="code" id="display-code">{{ code }}</span>
        </div>

        <div class="players-section">
            <h2>Players <span id="player-count">(0)</span></h2>
            <div id="player-list" class="player-list"></div>
        </div>

        <div id="host-controls" class="host-controls" style="display: none;">
            <h3>Settings</h3>
            <div class="settings-grid">
                <div class="setting">
                    <label>Tasks per player</label>
                    <div class="number-control">
                        <button class="btn-small" onclick="adjustSetting('tasks', -1)">-</button>
                        <span id="setting-tasks">5</span>
                        <button class="btn-small" onclick="adjustSetting('tasks', 1)">+</button>
                    </div>
                </div>
                <div class="setting">
                    <label>Impostors</label>
                    <div class="number-control">
                        <button class="btn-small" onclick="adjustSetting('impostors', -1)">-</button>
                        <span id="setting-impostors">1</span>
                        <button class="btn-small" onclick="adjustSetting('impostors', 1)">+</button>
                    </div>
                </div>
            </div>

            <!-- Advanced Roles Settings -->
            <div class="advanced-roles-settings">
                <div class="section-header" onclick="toggleAdvancedRoles()">
                    <h4>Advanced Roles</h4>
                    <span id="advanced-roles-toggle-icon">-</span>
                </div>
                <div id="advanced-roles-content" style="display: block;">
                    <!-- Crewmate Variants -->
                    <div class="role-category">
                        <h5 class="category-crew">Crewmate Variants</h5>
                        <div class="role-config-item">
                            <label class="toggle">
                                <input type="checkbox" id="toggle-sheriff" onchange="toggleRole('sheriff')">
                                <span>Sheriff</span>
                            </label>
                            <span class="role-desc">Shoot impostors (miss = die)</span>
                        </div>
                        <div class="role-config-item">
                            <label class="toggle">
                                <input type="checkbox" id="role-engineer" onchange="toggleAdvancedRole('engineer')">
                                <span>Engineer</span>
                            </label>
                            <span class="role-desc">Fix one sabotage remotely</span>
                        </div>
                        <div class="role-config-item">
                            <label class="toggle">
                                <input type="checkbox" id="role-captain" onchange="toggleAdvancedRole('captain')">
                                <span>Captain</span>
                            </label>
                            <span class="role-desc">Remote meeting from anywhere</span>
                        </div>
                        <div class="role-config-item">
                            <label class="toggle">
                                <input type="checkbox" id="role-mayor" onchange="toggleAdvancedRole('mayor')">
                                <span>Mayor</span>
                            </label>
                            <span class="role-desc">Vote counts twice</span>
                        </div>
                        <div class="role-config-item">
                            <label class="toggle">
                                <input type="checkbox" id="role-nice_guesser" onchange="toggleAdvancedRole('nice_guesser')">
                                <span>Bounty Hunter</span>
                            </label>
                            <span class="role-desc">Guess roles (risky!)</span>
                        </div>
                        <div class="role-config-item">
                            <label class="toggle">
                                <input type="checkbox" id="role-spy" onchange="toggleAdvancedRole('spy')">
                                <span>Spy</span>
                            </label>
                            <span class="role-desc">Appears as impostor</span>
                        </div>
                        <div class="role-config-item">
                            <label class="toggle">
                                <input type="checkbox" id="role-swapper" onchange="toggleAdvancedRole('swapper')">
                                <span>Swapper</span>
                            </label>
                            <span class="role-desc">Swap votes between players</span>
                        </div>
                        <div class="role-config-item">
                            <label class="toggle">
                                <input type="checkbox" id="role-noise_maker" onchange="toggleAdvancedRole('noise_maker')">
                                <span>Noise Maker</span>
                            </label>
                            <span class="role-desc">Choose who finds you</span>
                        </div>
                    </div>

                    <!-- Impostor Variants -->
                    <div class="role-category">
                        <h5 class="category-impostor">Impostor Variants</h5>
                        <div class="role-config-item">
                            <label class="toggle">
                                <input type="checkbox" id="role-evil_guesser" onchange="toggleAdvancedRole('evil_guesser')">
                                <span>Riddler</span>
                            </label>
                            <span class="role-desc">Guess roles (risky!)</span>
                        </div>
                        <div class="role-config-item">
                            <label class="toggle">
                                <input type="checkbox" id="role-bounty_hunter" onchange="toggleAdvancedRole('bounty_hunter')">
                                <span>Rampager</span>
                            </label>
                            <span class="role-desc">Faster kills on target</span>
                        </div>
                        <div class="role-config-item">
                            <label class="toggle">
                                <input type="checkbox" id="role-cleaner" onchange="toggleAdvancedRole('cleaner')">
                                <span>Cleaner</span>
                            </label>
                            <span class="role-desc">Move bodies elsewhere</span>
                        </div>
                        <div class="role-config-item">
                            <label class="toggle">
                                <input type="checkbox" id="role-venter" onchange="toggleAdvancedRole('venter')">
                                <span>Venter</span>
                            </label>
                            <span class="role-desc">Can go outside/through vents</span>
                        </div>
                    </div>

                    <!-- Neutral Roles -->
                    <div class="role-category">
                        <h5 class="category-neutral">Neutral Roles</h5>
                        <div class="role-config-item">
                            <label class="toggle">
                                <input type="checkbox" id="toggle-jester" onchange="toggleRole('jester')">
                                <span>Jester</span>
                            </label>
                            <span class="role-desc">Get voted out to win</span>
                        </div>
                        <div class="role-config-item">
                            <label class="toggle">
                                <input type="checkbox" id="toggle-lonewolf" onchange="toggleRole('lonewolf')">
                                <span>Lone Wolf</span>
                            </label>
                            <span class="role-desc">Kill everyone to win</span>
                        </div>
                        <div class="role-config-item">
                            <label class="toggle">
                                <input type="checkbox" id="role-vulture" onchange="toggleAdvancedRole('vulture')">
                                <span>Vulture</span>
                            </label>
                            <span class="role-desc">Eat bodies to win</span>
                            <div class="role-sub-setting" id="vulture-eat-setting" style="display: none;">
                                <span>Bodies needed:</span>
                                <button class="btn btn-tiny" onclick="adjustSetting('vulture_eat_count', -1)">-</button>
                                <span id="vulture-eat-count-display">3</span>
                                <button class="btn btn-tiny" onclick="adjustSetting('vulture_eat_count', 1)">+</button>
                            </div>
                        </div>
                    </div>

                    <!-- Special Roles -->
                    <div class="role-category">
                        <h5 class="category-special">Special Roles</h5>
                        <div class="role-config-item">
                            <label class="toggle">
                                <input type="checkbox" id="toggle-minion" onchange="toggleRole('minion')">
                                <span>Minion</span>
                            </label>
                            <span class="role-desc">Wins with impostors (blind)</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Per-Character Cooldown Settings -->
            <div id="cooldown-settings" class="cooldown-settings" style="display: none;">
                <!-- Impostor Cooldown -->
                <div class="cooldown-row" id="impostor-cooldown-row">
                    <span class="role-impostor">Impostor Kill</span>
                    <div class="number-control">
                        <button class="btn-small" onclick="adjustSetting('impostor_cooldown', -5)">-</button>
                        <span class="timer-value"><span id="setting-impostor-cooldown">45</span>s</span>
                        <button class="btn-small" onclick="adjustSetting('impostor_cooldown', 5)">+</button>
                    </div>
                </div>
                <!-- Sheriff Cooldown -->
                <div class="cooldown-row" id="sheriff-cooldown-row" style="display: none;">
                    <span class="role-sheriff">Sheriff Shoot</span>
                    <div class="number-control">
                        <button class="btn-small" onclick="adjustSetting('sheriff_cooldown', -5)">-</button>
                        <span class="timer-value"><span id="setting-sheriff-cooldown">45</span>s</span>
                        <button class="btn-small" onclick="adjustSetting('sheriff_cooldown', 5)">+</button>
                    </div>
                </div>
                <!-- Lone Wolf Cooldown -->
                <div class="cooldown-row" id="lonewolf-cooldown-row" style="display: none;">
                    <span class="role-lone-wolf">Lone Wolf Kill</span>
                    <div class="number-control">
                        <button class="btn-small" onclick="adjustSetting('lonewolf_cooldown', -5)">-</button>
                        <span class="timer-value"><span id="setting-lonewolf-cooldown">45</span>s</span>
                        <button class="btn-small" onclick="adjustSetting('lonewolf_cooldown', 5)">+</button>
                    </div>
                </div>
            </div>

            <!-- Sabotage Settings -->
            <div class="sabotage-settings">
                <div class="section-header" onclick="toggleSabotageSettings()">
                    <h4>Sabotage</h4>
                    <span id="sabotage-toggle-icon">-</span>
                </div>
                <div id="sabotage-settings-content" style="display: block;">
                    <label class="toggle">
                        <input type="checkbox" id="toggle-sabotage" onchange="toggleSabotageSetting()">
                        <span>Enable Sabotage</span>
                    </label>
                    <div id="sabotage-config" style="display: none;">
                        <div class="setting">
                            <label>Sabotage Cooldown</label>
                            <div class="number-control">
                                <button class="btn-small" onclick="adjustSetting('sabotage_cooldown', -5)">-</button>
                                <span class="timer-value"><span id="setting-sabotage-cooldown">90</span>s</span>
                                <button class="btn-small" onclick="adjustSetting('sabotage_cooldown', 5)">+</button>
                            </div>
                        </div>
                        <div class="sabotage-list">
                            <!-- Sabotage 1: Lights -->
                            <div class="sabotage-item">
                                <label class="toggle">
                                    <input type="checkbox" id="toggle-sab-1" checked onchange="toggleSabotageItem(1)">
                                    <span id="sab-1-name">Lights</span>
                                </label>
                                <span class="sab-type">(no timer)</span>
                            </div>
                            <!-- Sabotage 2: Reactor -->
                            <div class="sabotage-item">
                                <label class="toggle">
                                    <input type="checkbox" id="toggle-sab-2" checked onchange="toggleSabotageItem(2)">
                                    <span id="sab-2-name">Reactor</span>
                                </label>
                                <div class="number-control">
                                    <button class="btn-small" onclick="adjustSabotageTimer(2, -5)">-</button>
                                    <span class="timer-value"><span id="sab-2-timer">45</span>s</span>
                                    <button class="btn-small" onclick="adjustSabotageTimer(2, 5)">+</button>
                                </div>
                            </div>
                            <!-- Sabotage 3: O2 -->
                            <div class="sabotage-item">
                                <label class="toggle">
                                    <input type="checkbox" id="toggle-sab-3" checked onchange="toggleSabotageItem(3)">
                                    <span id="sab-3-name">O2</span>
                                </label>
                                <div class="number-control">
                                    <button class="btn-small" onclick="adjustSabotageTimer(3, -5)">-</button>
                                    <span class="timer-value"><span id="sab-3-timer">45</span>s</span>
                                    <button class="btn-small" onclick="adjustSabotageTimer(3, 5)">+</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Meeting & Voting Settings -->
            <div class="meeting-voting-settings">
                <div class="section-header" onclick="toggleMeetingSettings()">
                    <h4>Meetings & Voting</h4>
                    <span id="meeting-toggle-icon">+</span>
                </div>
                <div id="meeting-settings-content" style="display: none;">
                    <label class="toggle">
                        <input type="checkbox" id="toggle-voting" onchange="toggleVotingSetting()">
                        <span>Enable In-App Voting</span>
                    </label>
                    <div id="voting-config" style="display: none;">
                        <label class="toggle">
                            <input type="checkbox" id="toggle-anonymous" onchange="toggleAnonymousVoting()">
                            <span>Anonymous Voting</span>
                        </label>
                        <div class="setting">
                            <label>Voting Timer</label>
                            <div class="number-control">
                                <button class="btn-small" onclick="adjustSetting('meeting_timer', -10)">-</button>
                                <span class="timer-value"><span id="setting-meeting-timer">120</span>s</span>
                                <button class="btn-small" onclick="adjustSetting('meeting_timer', 10)">+</button>
                            </div>
                        </div>
                        <div class="setting">
                            <label>Warning Sound At</label>
                            <div class="number-control">
                                <button class="btn-small" onclick="adjustSetting('meeting_warning', -5)">-</button>
                                <span class="timer-value"><span id="setting-meeting-warning">30</span>s</span>
                                <button class="btn-small" onclick="adjustSetting('meeting_warning', 5)">+</button>
                            </div>
                        </div>
                        <div class="setting">
                            <label>Discussion Time</label>
                            <div class="number-control">
                                <button class="btn-small" onclick="adjustSetting('discussion_time', -5)">-</button>
                                <span class="timer-value"><span id="setting-discussion-time">5</span>s</span>
                                <button class="btn-small" onclick="adjustSetting('discussion_time', 5)">+</button>
                            </div>
                        </div>
                        <div class="setting">
                            <label>Results Display Time</label>
                            <div class="number-control">
                                <button class="btn-small" onclick="adjustSetting('vote_results_duration', -5)">-</button>
                                <span class="timer-value"><span id="setting-vote-results-duration">5</span>s</span>
                                <button class="btn-small" onclick="adjustSetting('vote_results_duration', 5)">+</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Task Management -->
            <div class="task-management">
                <div class="section-header" onclick="toggleTaskList()">
                    <h4>Manage Tasks</h4>
                    <span id="task-toggle-icon">+</span>
                </div>
                <div id="task-management-content" class="collapsible-content" style="display: none;">
                    <div class="add-task-form">
                        <input type="text" id="new-task-input" placeholder="New task name" maxlength="30">
                        <button class="btn-small" onclick="addTask()">Add</button>
                    </div>
                    <div id="available-tasks-list" class="available-tasks-list"></div>
                </div>
            </div>

            <button class="btn btn-primary btn-large" id="start-game-btn" onclick="startGame()">
                START GAME
            </button>
        </div>

        <!-- Rules and Leave Buttons (visible to all) -->
        <div class="lobby-actions">
            <button class="btn btn-secondary" onclick="showRules()">
                How to Play
            </button>
            <button class="btn btn-danger-outline" onclick="leaveGame()">
                Leave Game
            </button>
        </div>

        <div id="waiting-message" class="waiting-message">
            Waiting for host to start...
        </div>
    </div>

    <!-- Game Screen -->
    <div id="game-screen" class="screen" style="display: none;">
        <!-- Sabotage Alert Banner (above tasks, pushes content down) -->
        <div id="sabotage-alert" class="sabotage-alert" style="display: none;">
            <div class="sabotage-alert-content">
                <div class="sabotage-name" id="active-sabotage-name">LIGHTS OUT!</div>
                <div class="sabotage-timer" id="active-sabotage-timer" style="display: none;">
                    <span id="sabotage-remaining">45</span>s
                </div>
                <div class="sabotage-fix-info" id="sabotage-fix-info"></div>
                <button class="btn btn-success" id="fix-sabotage-btn" onclick="fixSabotage()">FIX</button>
                <button class="btn btn-success" id="hold-sabotage-btn" style="display: none;"
                    onmousedown="holdReactorStart()" onmouseup="holdReactorEnd()"
                    ontouchstart="holdReactorStart()" ontouchend="holdReactorEnd()">
                    HOLD TO FIX
                </button>
            </div>
        </div>

        <!-- Tasks at top (visible immediately) -->
        <div class="tasks-section">
            <h3>Your Tasks</h3>
            <div id="task-list" class="task-list"></div>
        </div>

        <div class="action-buttons">
            <button class="btn btn-danger btn-large" id="report-body-btn" onclick="reportBody()">
                REPORT BODY
            </button>
            <button class="btn btn-warning-outline" id="call-meeting-btn" onclick="callMeeting()">
                CALL MEETING
            </button>
            <button class="btn btn-secondary" id="im-dead-btn" onclick="markDead()">
                I'M DEAD
            </button>
            <button class="btn btn-secondary" id="map-btn" onclick="showMapGallery()">
                MAP
            </button>
            <button class="btn btn-secondary" id="roles-btn" onclick="showRoleGuide()">
                ROLES
            </button>
        </div>

        <!-- Scroll hint right below buttons -->
        <div class="scroll-hint">
            <span class="scroll-arrow">↓</span>
            <span class="scroll-text">Scroll down to see your role</span>
            <span class="scroll-arrow">↓</span>
        </div>

        <!-- Scroll spacer to hide role below the fold -->
        <div class="scroll-spacer"></div>

        <!-- Role info below the fold (scroll down to see) -->
        <div class="role-info-section">
            <!-- Compact role indicator -->
            <div class="role-badge" id="role-badge">
                <span class="role-name-small" id="role-name-badge">CREWMATE</span>
            </div>

            <div class="role-display" id="role-display">
                <span class="role-team" id="role-team">CREWMATE</span>
                <span class="role-label">You are</span>
                <span class="role-name" id="role-name">CREWMATE</span>
                <p class="role-description" id="role-description"></p>
            </div>

            <!-- Role ability buttons - below role card, only visible for specific roles -->
            <button class="btn btn-jester btn-large" id="jester-voted-btn" onclick="jesterVotedOut()" style="display: none;">
                I WAS VOTED OUT!
            </button>

            <!-- Engineer: Fix sabotage remotely (one use) -->
            <button class="btn btn-ability btn-engineer-fix btn-large" id="engineer-fix-btn" onclick="engineerFix()" style="display: none;">
                FIX SABOTAGE REMOTELY
            </button>

            <!-- Captain: Remote meeting from anywhere (one use) -->
            <button class="btn btn-ability btn-captain-meeting btn-large" id="captain-meeting-btn" onclick="captainMeeting()" style="display: none;">
                REMOTE MEETING
            </button>

            <!-- Vulture: Eat body -->
            <div id="vulture-eat-section" class="ability-section" style="display: none;">
                <div class="vulture-progress">
                    <span id="vulture-count">0</span> / <span id="vulture-needed">3</span> bodies eaten
                </div>
                <div id="vulture-body-list" class="vulture-body-list">
                    <!-- Populated with dead players -->
                </div>
            </div>

            <!-- Rampager: Target display and "Was it you?" flow -->
            <div id="bounty-hunter-section" class="ability-section" style="display: none;">
                <div class="bounty-target-display" style="background: rgba(185,28,28,0.2); border: 1px solid #b91c1c; border-radius: 8px; padding: 10px; margin-bottom: 8px; text-align: center;">
                    <span style="color: #94a3b8; font-size: 12px;">TARGET</span>
                    <div id="bounty-target-name" style="color: #ef4444; font-size: 20px; font-weight: bold;"></div>
                    <div id="bounty-kills-display" style="color: #94a3b8; font-size: 12px; margin-top: 4px;"></div>
                </div>
                <div id="bounty-was-it-you" style="display: none; text-align: center; margin-top: 8px;">
                    <div id="bounty-prompt-text" style="color: #fbbf24; font-size: 14px; font-weight: bold; margin-bottom: 8px;"></div>
                    <div style="display: flex; gap: 8px;">
                        <button class="btn btn-large" onclick="bountyKillClaim(true)" style="flex: 1; background: #22c55e; color: white;">YES</button>
                        <button class="btn btn-large" onclick="bountyKillClaim(false)" style="flex: 1; background: #6b7280; color: white;">NO</button>
                    </div>
                </div>
            </div>

            <div id="fellow-impostors" class="fellow-impostors" style="display: none;">
                <span class="label">Fellow Impostors:</span>
                <span id="impostor-names"></span>
            </div>

            <!-- Sabotage Section (Impostor only) -->
            <div id="impostor-sabotage-section" class="sabotage-section" style="display: none;">
                <h3>Sabotage</h3>
                <div id="impostor-sabotage-buttons" class="sabotage-buttons">
                    <!-- Dynamically populated -->
                </div>
                <div id="impostor-sabotage-cooldown" class="sabotage-cooldown" style="display: none;">
                    Cooldown: <span id="impostor-sabotage-cooldown-time">0</span>s
                </div>
            </div>

            <!-- Kill Cooldown Timer (for impostor/sheriff) -->
            <div id="cooldown-timer" class="cooldown-timer" style="display: none;">
                <div class="cooldown-display">
                    <span id="cooldown-text">Kill Ready</span>
                    <button class="btn btn-small start-cooldown-btn" id="start-cooldown-btn" onclick="startCooldown()">Start Timer</button>
                </div>
            </div>

            <!-- Task Progress (hidden between meetings) -->
            <div class="task-progress" id="game-task-progress" style="display: none;">
                <div class="progress-bar">
                    <div class="progress-fill" id="progress-fill" style="width: 0%"></div>
                </div>
                <span class="progress-text" id="progress-text">0% Tasks Complete</span>
            </div>
        </div>
    </div>

    <!-- Meeting Screen -->
    <div id="meeting-screen" class="screen" style="display: none;">
        <div class="meeting-header" id="meeting-header">
            <h1 id="meeting-title">MEETING</h1>
            <p id="meeting-caller"></p>
        </div>
        <button class="btn btn-secondary btn-small-inline" onclick="showRoleGuide()" style="margin: 4px 0 4px 12px; font-size: 11px; padding: 3px 10px; opacity: 0.7;">Role Guide</button>

        <!-- Gathering Phase (waiting for caller to start meeting) -->
        <div id="gathering-section" style="display: none;">
            <div id="gathering-message" class="gathering-message">
                Waiting for meeting to start...
            </div>
            <button class="btn btn-primary btn-large" id="start-meeting-btn" onclick="startVotingPhase()" style="display: none;">
                START MEETING
            </button>
        </div>

        <!-- Voting Timer -->
        <div class="meeting-timer" id="meeting-timer" style="display: none;">
            <div class="timer-circle">
                <span id="meeting-timer-display">2:00</span>
            </div>
        </div>

        <div class="task-progress">
            <div class="progress-bar">
                <div class="progress-fill" id="meeting-progress-fill" style="width: 0%"></div>
            </div>
            <span class="progress-text" id="meeting-progress-text">0% Tasks Complete</span>
        </div>

        <!-- Voting Section -->
        <div class="voting-section" id="voting-section" style="display: none;">
            <h3>Vote to Eliminate</h3>
            <div id="vote-options" class="vote-options">
                <!-- Populated with alive players as vote buttons -->
            </div>
            <button class="btn btn-secondary btn-large" id="skip-vote-btn" onclick="castVote(null)">
                SKIP VOTE
            </button>
            <div class="vote-status" id="vote-status">
                <span id="votes-cast-count">0</span> / <span id="votes-needed-count">0</span> voted
            </div>
            <!-- Vote feed for non-anonymous voting -->
            <div class="vote-feed" id="vote-feed" style="display: none;">
                <!-- Shows "Player voted for Target" entries -->
            </div>
            <!-- Swapper UI -->
            <div id="swapper-section" style="display: none; margin-top: 15px; padding: 10px; background: rgba(236,72,153,0.1); border: 1px solid #ec4899; border-radius: 8px;">
                <h4 style="color: #ec4899; margin: 0 0 8px 0; font-size: 14px;">SWAP VOTES</h4>
                <div id="swapper-controls">
                    <button class="btn btn-secondary" id="swap-player1-btn" onclick="openSwapSelect(1)" style="width: 100%; margin-bottom: 6px; font-size: 13px;">[Select Player 1]</button>
                    <span style="color: #94a3b8; display: block; text-align: center; font-size: 12px;">&#8593; swap with &#8595;</span>
                    <button class="btn btn-secondary" id="swap-player2-btn" onclick="openSwapSelect(2)" style="width: 100%; margin-top: 6px; margin-bottom: 8px; font-size: 13px;">[Select Player 2]</button>
                    <button class="btn btn-primary" id="confirm-swap-btn" onclick="confirmSwap()" disabled style="width: 100%; font-size: 13px;">CONFIRM SWAP</button>
                </div>
                <div id="swapper-result" style="display: none; color: #ec4899; text-align: center; font-size: 14px; padding: 8px;"></div>
            </div>
            <!-- Swap Player Select Modal -->
            <div id="swap-select-modal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 1001; justify-content: center; align-items: center;">
                <div style="background: #1e293b; border-radius: 12px; padding: 15px; max-width: 300px; width: 90%;">
                    <h4 style="color: #ec4899; margin: 0 0 10px 0;">Select Player</h4>
                    <div id="swap-select-options"></div>
                    <button class="btn btn-secondary" onclick="closeSwapSelect()" style="width: 100%; margin-top: 8px;">Cancel</button>
                </div>
            </div>
            <!-- Guesser Role Select Modal -->
            <div id="guesser-modal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.85); z-index: 1002; justify-content: center; align-items: center;">
                <div style="background: #1e293b; border-radius: 12px; padding: 15px; max-width: 320px; width: 90%; max-height: 70vh; overflow-y: auto;">
                    <h4 style="color: #14b8a6; margin: 0 0 5px 0;">Guess Role</h4>
                    <p id="guesser-target-label" style="color: #94a3b8; font-size: 13px; margin: 0 0 10px 0;"></p>
                    <div id="guesser-role-options"></div>
                    <button class="btn btn-secondary" onclick="closeGuesserModal()" style="width: 100%; margin-top: 8px;">Cancel</button>
                </div>
            </div>
        </div>

        <!-- Vote Results Section -->
        <div class="vote-results" id="vote-results-section" style="display: none;">
            <h3>Vote Results</h3>
            <div id="vote-results-list"></div>
            <div id="vote-outcome"></div>
            <div id="vote-results-countdown" style="color: #94a3b8; margin-top: 10px; font-size: 14px;"></div>
        </div>

        <!-- Players Lists (shown when voting disabled) -->
        <div class="meeting-players" id="meeting-players-section">
            <div class="alive-section">
                <h3>Alive</h3>
                <div id="alive-list" class="player-list"></div>
            </div>
            <div class="dead-section">
                <h3>Dead</h3>
                <div id="dead-list" class="player-list"></div>
            </div>
        </div>

        <button class="btn btn-secondary btn-large" id="end-meeting-btn" onclick="endMeeting()">
            END MEETING
        </button>
    </div>

    <!-- Game Over Screen -->
    <div id="gameover-screen" class="screen" style="display: none;">
        <div class="gameover-header">
            <h1 id="winner-text">CREWMATES WIN!</h1>
        </div>

        <div class="roles-reveal">
            <h3>Roles</h3>
            <div id="roles-list" class="roles-list"></div>
        </div>

        <button class="btn btn-primary btn-large" onclick="returnToLobby()">
            PLAY AGAIN
        </button>
    </div>

    <div class="error-message" id="error-message"></div>

    <!-- Rules Modal -->
    <div id="rules-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2>How to Play</h2>
                <button class="modal-close" onclick="hideRules()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="rule-section">
                    <h3 class="role-crewmate">Crewmate</h3>
                    <p>Complete all your tasks OR vote out all impostors to win. Work together to find who's lying!</p>
                </div>
                <div class="rule-section">
                    <h3 class="role-impostor">Impostor</h3>
                    <p>Eliminate crewmates until impostors equal or outnumber them. Blend in, fake tasks, and don't get caught!</p>
                </div>
                <div class="rule-section" id="rule-jester" style="display: none;">
                    <h3 class="role-jester">Jester</h3>
                    <p>Get yourself voted out during a meeting to win! Act suspicious, but not TOO suspicious...</p>
                </div>
                <div class="rule-section" id="rule-lonewolf" style="display: none;">
                    <h3 class="role-lone-wolf">Lone Wolf</h3>
                    <p>Be one of the last 2 players alive with no impostors remaining. You're on your own!</p>
                </div>
                <div class="rule-section" id="rule-minion" style="display: none;">
                    <h3 class="role-minion">Minion</h3>
                    <p>Help the impostors win! You know who they are, but you cannot kill. Misdirect the crew!</p>
                </div>
                <div class="rule-section" id="rule-sheriff" style="display: none;">
                    <h3 class="role-sheriff">Sheriff</h3>
                    <p>You have tasks like a crewmate, but you can also shoot! Whisper to a player that you're shooting them. If they're an impostor, they die. If they're innocent, YOU die! (Trust-based)</p>
                </div>
                <div class="rule-section">
                    <h3>Gameplay</h3>
                    <ul>
                        <li><strong>Tasks:</strong> Physical tasks around the venue. Tap to mark complete.</li>
                        <li><strong>Meetings:</strong> Anyone can call a meeting to discuss. Vote verbally in person!</li>
                        <li><strong>Death:</strong> If eliminated, tap "I'm Dead" to update the game.</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- Map Gallery Modal -->
    <div id="map-modal" class="modal" style="display: none;">
        <div class="modal-content map-modal-content">
            <div class="modal-header">
                <h2>Map</h2>
                <button class="modal-close" onclick="hideMapGallery()">&times;</button>
            </div>
            <div class="map-gallery">
                <div class="map-swiper" id="map-swiper">
                    <div class="map-slide active" data-index="0">
                        <img src="/static/images/maps/downstairs1.png" alt="Downstairs 1" class="zoomable-map">
                        <div class="map-label">Downstairs 1</div>
                    </div>
                    <div class="map-slide" data-index="1">
                        <img src="/static/images/maps/downstairs2.png" alt="Downstairs 2" class="zoomable-map">
                        <div class="map-label">Downstairs 2</div>
                    </div>
                    <div class="map-slide" data-index="2">
                        <img src="/static/images/maps/upstairs1.png" alt="Upstairs 1" class="zoomable-map">
                        <div class="map-label">Upstairs 1</div>
                    </div>
                    <div class="map-slide" data-index="3">
                        <img src="/static/images/maps/upstairs2.png" alt="Upstairs 2" class="zoomable-map">
                        <div class="map-label">Upstairs 2</div>
                    </div>
                </div>
                <div class="map-indicators">
                    <span class="map-indicator active" data-index="0" onclick="goToMapSlide(0)"></span>
                    <span class="map-indicator" data-index="1" onclick="goToMapSlide(1)"></span>
                    <span class="map-indicator" data-index="2" onclick="goToMapSlide(2)"></span>
                    <span class="map-indicator" data-index="3" onclick="goToMapSlide(3)"></span>
                </div>
                <div class="map-nav">
                    <button class="map-nav-btn" onclick="prevMapSlide()">&#8249;</button>
                    <button class="map-nav-btn" onclick="nextMapSlide()">&#8250;</button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Noise Maker Selection Modal -->
<div id="noise-maker-modal" class="modal" style="display: none;">
    <div class="modal-content" style="max-width: 350px;">
        <div class="modal-header">
            <h2 style="color: #f59e0b;">Select Who Killed You</h2>
        </div>
        <p style="color: #94a3b8; font-size: 13px; margin-bottom: 10px;">They will "find" your body and trigger a meeting.</p>
        <div id="noise-maker-player-list" style="max-height: 50vh; overflow-y: auto;">
            <!-- Populated with alive players -->
        </div>
    </div>
</div>

<style>
.role-guide-desc.expanded {
    max-height: 100px !important;
    margin-top: 6px !important;
}
</style>
<!-- Role Guide Modal -->
<div id="role-guide-modal" class="modal" style="display: none;">
    <div class="modal-content" style="max-width: 500px; max-height: 80vh; overflow-y: auto;">
        <div class="modal-header">
            <h2>Role Guide</h2>
            <button class="modal-close" onclick="hideRoleGuide()">&times;</button>
        </div>
        <div id="role-guide-content" style="padding: 10px;">
            <p style="color: #94a3b8;">Loading...</p>
        </div>
    </div>
</div>

<!-- Game sounds -->
<audio id="sound-game-start" preload="auto">
    <source src="/static/sounds/Start_of_game_role_reveal.mp3" type="audio/mpeg">
</audio>
<audio id="sound-meeting" preload="auto">
    <source src="/static/sounds/Meeting_or_body.mp3" type="audio/mpeg">
</audio>

<!-- Win condition sounds -->
<audio id="sound-crewmate-win" preload="auto">
    <source src="/static/sounds/Wincon Sounds/Crewmates_win.mp3" type="audio/mpeg">
</audio>
<audio id="sound-impostor-win" preload="auto">
    <source src="/static/sounds/Wincon Sounds/Imposters_win.mp3" type="audio/mpeg">
</audio>
<audio id="sound-jester-win" preload="auto">
    <source src="/static/sounds/Wincon Sounds/Jester_win.mp3" type="audio/mpeg">
</audio>
<audio id="sound-lonewolf-win" preload="auto">
    <source src="/static/sounds/Wincon Sounds/Lone_wolf_win.mp3" type="audio/mpeg">
</audio>
<audio id="sound-vulture-win" preload="auto">
    <source src="/static/sounds/Wincon Sounds/Vulture_win.mp3" type="audio/mpeg">
</audio>

<!-- Voting sounds -->
<audio id="sound-voting-warning" preload="auto">
    <source src="/static/sounds/Voting/Voting_warning.mp3" type="audio/mpeg">
</audio>
<audio id="sound-time-to-vote" preload="auto">
    <source src="/static/sounds/Voting/Time_to_vote.mp3" type="audio/mpeg">
</audio>

<!-- Sabotage sounds -->
<audio id="sound-lights-sabotage" preload="auto">
    <source src="/static/sounds/Sabotage/lights_sabotaged.mp3" type="audio/mpeg">
</audio>
<audio id="sound-lights-fixed" preload="auto">
    <source src="/static/sounds/Sabotage/lights_on.mp3" type="audio/mpeg">
</audio>
<audio id="sound-reactor-sabotage" preload="auto">
    <source src="/static/sounds/Sabotage/Reactor_Oxygen_sabotaged.mp3" type="audio/mpeg">
</audio>
<audio id="sound-reactor-fixed" preload="auto">
    <source src="/static/sounds/Sabotage/Reactor_Oxygen_on.mp3" type="audio/mpeg">
</audio>
<audio id="sound-death-meeting" preload="auto">
    <source src="/static/sounds/Death_during_meeting.mp3" type="audio/mpeg">
</audio>

<script>
    const gameCode = '{{ code }}';
    const sessionToken = localStorage.getItem('session_token');
    const playerId = localStorage.getItem('player_id');

    // === Role Constants (single source of truth) ===
    const IMPOSTOR_SABOTAGE_ROLES = ['Impostor', 'Riddler', 'Rampager', 'Cleaner', 'Venter'];
    const REAL_TASK_ROLES = ['Crewmate', 'Sheriff', 'Engineer', 'Captain', 'Mayor', 'Bounty Hunter', 'Spy', 'Swapper', 'Noise Maker'];
    const GUESSER_ROLES = ['Bounty Hunter', 'Riddler'];
    const IMPOSTOR_SUBTYPES = ['Rampager', 'Riddler', 'Cleaner', 'Venter', 'Minion'];
    const KILL_COOLDOWN_ROLES = ['Impostor', 'Rampager', 'Sheriff', 'Lone Wolf'];
</script>
<script src="/static/js/game-core.js?v={{ v }}"></script>
<script src="/static/js/game-sabotage.js?v={{ v }}"></script>
<script src="/static/js/game-meeting.js?v={{ v }}"></script>
<script src="/static/js/game-abilities.js?v={{ v }}"></script>
{% endblock %}
